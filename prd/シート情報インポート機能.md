# Googleスプレッドシートアドオン「カオナビデータ連携」要件定義書 (改訂4版)

## 1. 概要

### 1.1. 背景と目的

カオナビに蓄積された従業員データやカスタムシートの情報を、分析や二次加工のためにGoogleスプレッドシートへ手軽に出力したいというニーズに応える。本アドオンにより、APIに関する専門知識がないユーザーでも、簡単な操作で必要なデータをスプレッドシート上に展開できるようになることを目的とします。

### 1.2. 対象利用者

* Google Workspaceを利用しているカオナビの契約企業
* 人事データなどをスプレッドシートで分析・活用したい担当者

---

## 2. システム要件

### 2.1. 動作環境

* Googleスプレッドシートが利用可能なGoogle Workspaceアカウント
* V8ランタイムが有効なGoogle Apps Script環境

### 2.2. 利用API

* カオナビ API v2.0
    * URL: https://developer.kaonavi.jp/api/v2.0/index.html

### 2.3. 認証方式

* カオナビAPIへのアクセスには、「Consumer Key」と「Consumer Secret」による認証が必要です。
* **認証フロー（2段階プロセス）：**
    1. **アクセストークン取得：** Consumer KeyとConsumer Secretを`consumer_key:consumer_secret`形式で結合し、Base64エンコードしてBasic認証で`POST /api/v2.0/token`を呼び出し、アクセストークンを取得します。
    2. **API実行：** 取得したアクセストークンを`Kaonavi-Token`ヘッダーに設定して各種APIを実行します。
* **トークン管理：** 取得したアクセストークンは`CacheService.getUserCache()`を利用して有効期限の5分前まで（または最低5分間）キャッシュし、効率的に利用します。
* **エラーハンドリング：** 401エラー（認証エラー）が発生した場合、キャッシュされたトークンを削除し、自動的に新しいトークンを取得して1回だけ再試行します。
* これらの認証情報は、初回利用時にダイアログで入力を促し、Google Apps Scriptの `PropertiesService.getUserProperties()` を利用して、利用者ごとに安全に保管します。
* ユーザーは任意のタイミングで認証情報を更新できます。

### 2.4. 必要な権限設定

* **Google Apps Scriptの権限：** `appsscript.json`マニフェストファイルで以下の権限を明示的に設定する必要があります：
    * `https://www.googleapis.com/auth/spreadsheets` - スプレッドシートの読み書き
    * `https://www.googleapis.com/auth/script.external_request` - 外部API（カオナビAPI）への通信
* **権限承認フロー：** 初回実行時にユーザーに権限承認を求め、外部API通信の許可を得る必要があります。

---

## 3. 機能要件

### 3.1. UI/UX

* **カスタムメニュー**
    * `カオナビ連携`
        * `メンバー情報を取得`
        * `シート情報を取得`
        * `カスタムシートを作成`
        * `認証情報を更新`
* **認証情報入力ダイアログ:**
    * 「Consumer Key」と「Consumer Secret」を入力するためのテキストボックスを持つモーダルダイアログ。
    * 初回実行時、または認証情報が未設定の状態で各機能が呼び出された場合に表示されます。
    * `認証情報を更新` メニューからも表示されます。
* **出力方法選択ダイアログ:**
    * データ出力時に「新規シートに作成」と「現在のアクティブシートに上書き」のどちらかを選択させるモーダルダイアログ。
    * **具体的なメッセージ例：**
        ```
        新規シートを作成しますか？
        
        「はい」: 新規シートに出力
        「いいえ」: 現在のシートに上書き
        「キャンセル」: 処理を中止
        ```
    * **ボタンセット：** `ui.ButtonSet.YES_NO_CANCEL`を使用
    * **戻り値の処理：** `ui.Button.YES`は新規作成、`ui.Button.NO`は上書き、`ui.Button.CANCEL`は処理中止として明確に定義
* **シート選択UI:**
    * `シート情報を取得` 機能で使用します。
    * ユーザーがアクセス可能なシートの一覧（**シート名**と**シートID**を併記）を表示するサイドバーまたはモーダルダイアログ。ユーザーはこの一覧から取得したいシートを選択します。

### 3.2. 認証情報の管理

* **初回実行フロー:**
    1.  いずれかの機能が初めて実行されると、`PropertiesService` に認証情報が保存されているか確認します。
    2.  保存されていない場合、認証情報入力ダイアログを表示します。
    3.  ユーザーが入力した「Consumer Key」「Consumer Secret」を `PropertiesService.getUserProperties()` を使って保存します。
* **認証情報更新フロー:**
    1.  ユーザーが `認証情報を更新` メニューを選択します。
    2.  現在の設定情報を破棄するか確認した後、認証情報入力ダイアログを表示します。
    3.  入力された新しい情報を `PropertiesService` に上書き保存します。

### 3.3. 機能1: メンバー情報の取得と表作成

ユーザーがメニューから `メンバー情報を取得` を選択すると、カオナビ上のメンバー情報を取得し、指定した方法でシートに出力します。

* **トリガー:** ユーザーによるメニュー操作
* **処理フロー:**
    1.  認証情報を確認します。未設定の場合は、認証情報入力フロー（3.2）を先に実行します。
    2.  **出力方法の選択:** 出力方法選択ダイアログを表示し、ユーザーに「新規作成」か「上書き」かを選ばせます。
    3.  **レイアウト定義の取得:** `GET /api/v2.0/member_layouts` APIを呼び出し、メンバー情報のレイアウト定義を取得します。
    4.  **メンバー情報の取得:** `GET /api/v2.0/members` APIを呼び出し、全メンバーの情報を取得します。
    5.  **シートへの出力:**
        * **新規作成の場合:** `メンバー情報_YYYYMMDDHHMMSS` 形式の新しいシートを作成し、1行目にヘッダー、2行目以降にデータを書き込みます。
        * **上書きの場合:** 現在アクティブなシートの内容をすべてクリアした後、1行目にヘッダー、2行目以降にデータを書き込みます。
* **エラーハンドリング:**
    * APIリクエストが失敗した場合（認証エラー等）、`SpreadsheetApp.getUi().alert()` でユーザーにエラー内容を通知します。
    * データが1件も取得できなかった場合も、その旨を通知します。

### 3.4. 機能2: シート情報の取得と表作成

ユーザーがメニューから `シート情報を取得` を選択すると、カオナビ上の特定のシート情報を取得し、指定した方法でシートに出力します。

* **トリガー:** ユーザーによるメニュー操作
* **処理フロー:**
    1.  認証情報を確認します。（エラー処理は3.3と同様）
    2.  **シートレイアウト一覧の取得とキャッシュ:** `GET /api/v2.0/sheet_layouts` APIを呼び出し、ユーザーがアクセス可能なシートのレイアウト情報一覧（シートID、シート名、項目定義など）を取得します。
        * 取得したレイアウト情報は、`CacheService.getUserCache()` を利用して一定時間（例: 1時間）キャッシュし、API呼び出しの回数を削減します。
    3.  **対象シートの選択:** キャッシュまたはAPIから取得した一覧情報を基に、シート選択UI（シート名とシートIDを併記）を表示し、ユーザーに取得対象のシートを選択させます。
    4.  **出力方法の選択:** 出力方法選択ダイアログを表示し、「新規作成」か「上書き」かを選ばせます。
    5.  **シートデータの取得:** `GET /api/v2.0/sheets/{sheet_id}` APIを呼び出し、選択されたIDのシートの**データのみ**を取得します。
    6.  **シートへの出力:**
        * **ヘッダーの準備:** 手順2で取得（またはキャッシュから読み出し）したレイアウト情報の中から、選択されたシートIDに対応する項目定義をヘッダーとして使用します。
        * **新規作成の場合:** `シート情報_{シート名}_YYYYMMDDHHMMSS` 形式の新しいシートを作成し、準備したヘッダーと取得したデータを書き込みます。
        * **上書きの場合:** 現在アクティブなシートの内容をクリアした後、準備したヘッダーと取得したデータを書き込みます。
* **エラーハンドリング:**
    * APIリクエスト失敗時、データが空の場合などは、その旨をユーザーに通知します。

### 3.5. 機能3: カスタムシートの作成

メンバー情報および複数のシート情報から、ユーザーが指定した項目のみを抽出し、一つの表として新しいシートに作成する機能。

* **トリガー:** ユーザーが `カスタムシートを作成` メニューを選択。
* **定義方法:**
    * ユーザーは、本アドオン専用の「**カスタムシート定義用シート**」をスプレッドシート内に手動で作成し、取得したい項目を定義します。
    * この定義用シートは、`kaonavi_custom_def` という固定のシート名で作成する必要があります。
    * 定義用シートのフォーマットは以下の2列形式とします。
        * **A列 (データソース):** 取得元の種類を指定します。
            * メンバー情報から取得する場合: `基本情報` と記載。
            * 特定のシートから取得する場合: 対象の**シート名**を記載。
        * **B列 (項目名):** 取得したい**項目名**を記載。
    * 定義用シートの上から下の順序が、出力されるカスタムシートの左から右のカラム順序に対応します。
* **処理フロー:**
    1.  認証情報を確認します。（エラー処理は機能1と同様）
    2.  `kaonavi_custom_def` という名前のシートを検索し、存在しない場合はエラーメッセージを表示して処理を中断します。
    3.  定義用シートのA列・B列を1行目から順に読み込み、取得対象となるデータソースと項目名のリストを作成します。
    4.  **データソースの特定と情報収集:**
        * 定義リストに含まれるユニークなデータソース名（`基本情報` およびシート名）を基に、必要なAPIを呼び出します。
        * **メンバー情報:** `基本情報` が含まれる場合、`GET /api/v2.0/members` を呼び出し、全メンバーの情報を取得します。
        * **シート情報:** シート名が含まれる場合、まず `GET /api/v2.0/sheet_layouts` でシート名とシートIDの対応を取得し、その後、必要なシートIDの `GET /api/v2.0/sheets/{sheet_id}` を呼び出して各シートのデータを取得します。
        * 取得したデータは、メンバーの識別子（`メンバーコード`など）をキーとしてメモリ上で整理・結合できるように準備します。
    5.  **カスタムシートの作成と出力:**
        * `カスタムシート_YYYYMMDDHHMMSS` という形式の新しいシートを作成します。
        * 1行目のヘッダーには、定義用シートのB列（項目名）をA1セルから順に書き込みます。
        * 2行目以降に、各メンバーのデータを書き込みます。各行は一人のメンバーに対応し、各列には定義されたデータソースから取得した対応する項目の値を出力します。
* **エラーハンドリング:**
    * 定義用シートが存在しない、フォーマットが不正（列が足りない等）の場合。
    * 定義されたシート名や項目名がカオナビ上に存在しない場合。
    * 上記の場合、エラー箇所と内容を具体的に`SpreadsheetApp.getUi().alert()` でユーザーに通知します。

---

## 4. 非機能要件

* **パフォーマンス:** APIレスポンスやGASの書き込み処理に時間がかかる場合を想定し、処理中は `SpreadsheetApp.getActiveSpreadsheet().toast('処理中です...');` のような通知を表示してユーザーに状況を伝えます。GASの実行時間制限（6分）を超える大量データは、初期リリースでは考慮対象外とします。
* **セキュリティ:** 認証情報は `PropertiesService.getUserProperties()` を使用し、スクリプト開発者からも閲覧できない形で、利用者ごとに安全に管理します。
* **メンテナンス性:** APIリクエスト部分、シート書き込み部分、UI制御部分など、機能ごとにコードをモジュール化（`.gs` ファイルを分割）し、可読性とメンテナンス性を高めます。

---

## 5. 開発環境・テスト要件

本アドオンの開発においては、迅速な開発サイクルと品質保証を目的として、ローカル環境での開発およびテストを可能とすることを要件とします。

### 5.1. ローカル開発環境 💻

* **ソースコード管理:** ソースコードはGitを用いてバージョン管理を行います。
* **開発ツール:** Googleが提供するCLIツール「**clasp**」を導入します。これにより、開発者は使い慣れたローカルのエディタ（VS Codeなど）でTypeScriptまたはJavaScriptを用いて開発し、コマンド一つでGoogle Apps Scriptプロジェクトにデプロイ（プッシュ）できるようにします。
* **依存関係の管理:** `npm` または `yarn` を利用して、`clasp` やGoogle Apps Scriptの型定義ファイル（`@types/google-apps-script`）などの開発に必要なパッケージを管理します。

### 5.2. ローカルテスト環境 🧪

* **ユニットテスト:** JavaScriptのテストフレームワーク（**Jest**などを推奨）を導入し、ビジネスロジックの単体テスト（ユニットテスト）をローカル環境で実行できるようにします。
* **モッキング:** ローカルのNode.js環境には `SpreadsheetApp` や `PropertiesService` といったGoogle Apps Script固有のグローバルオブジェクトが存在しないため、これらの**APIサービスを模倣（モック）する仕組み**を導入します。これにより、GASの実行環境に依存しない形でロジックの正当性を検証します。
* **テストの自動化:** `npm test` のようなコマンドで、ローカルのユニットテストを一括で実行できる環境を整備します。